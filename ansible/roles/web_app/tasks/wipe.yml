---
- name: Wipe web application
  when: web_app_wipe | bool
  tags:
    - web_app_wipe
  block:
    - name: Check if application directory exists
      ansible.builtin.stat:
        path: "{{ compose_project_dir | default('/opt/' + web_app_name) }}"
      register: app_dir_check
      tags:
        - web_app_wipe

    - name: Stop and remove containers with Docker Compose
      community.docker.docker_compose_v2:
        project_src: "{{ compose_project_dir | default('/opt/' + web_app_name) }}"
        state: absent
        remove_orphans: true
      when: app_dir_check.stat.exists
      ignore_errors: true # Continue if compose file missing or project not found
      register: compose_down_result
      tags:
        - web_app_wipe

    - name: Remove docker-compose.yml file
      ansible.builtin.file:
        path: "{{ compose_project_dir | default('/opt/' + web_app_name) }}/docker-compose.yml"
        state: absent
      when: app_dir_check.stat.exists
      tags:
        - web_app_wipe

    - name: Remove application directory
      ansible.builtin.file:
        path: "{{ compose_project_dir | default('/opt/' + web_app_name) }}"
        state: absent
      when: app_dir_check.stat.exists
      tags:
        - web_app_wipe

    - name: Optionally remove Docker images
      tags:
        - web_app_wipe

      block:
        - name: List Docker images for the application
          community.docker.docker_image_info:
            name:
              - "{{ dockerhub_username }}/{{ web_app_name }}:{{ docker_tag | default('latest') }}"
          register: image_info
          when: web_app_remove_images | default(false) | bool

        - name: Remove Docker images
          community.docker.docker_image:
            name: "{{ dockerhub_username }}/{{ web_app_name }}"
            tag: "{{ docker_tag | default('latest') }}"
            state: absent
          when:
            - web_app_remove_images | default(false) | bool
            - image_info.images | length > 0
          ignore_errors: true
    - name: Log wipe completion
      ansible.builtin.debug:
        msg:
          - "Application {{ web_app_name }} wiped successfully"
          - "Directory removed: {{ compose_project_dir | default('/opt/' + web_app_name) }}"
          - "Containers stopped: {{ 'Yes' if compose_down_result is not skipped else 'N/A' }}"
          - "Images removed: {{ 'Yes' if web_app_remove_images | default(false) | bool else 'No' }}"
      tags:
        - web_app_wipe

    - name: Write wipe to log file
      ansible.builtin.lineinfile:
        path: "/var/log/ansible-webapp-deploy.log"
        line: "{{ ansible_date_time.iso8601 }} - WIPE: Application {{ web_app_name }} completely removed"
        create: true
        mode: "0644"
      tags:
        - web_app_wipe
