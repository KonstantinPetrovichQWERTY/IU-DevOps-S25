- name: Common role tasks
  block:
    - name: Package management block
      block:
        - name: Update apt cache
          apt:
            update_cache: yes
            cache_valid_time: 3600
          register: apt_update_result
          tags: packages_update

        - name: Install common packages
          apt:
            name: "{{ common_packages }}"
            state: present
          tags: packages_install

      rescue:
        - name: Handle apt update failure
          debug:
            msg: "Apt update failed, attempting to fix missing packages"
          tags: packages_update

        - name: Fix missing package dependencies
          command: apt-get update --fix-missing
          become: true
          register: fix_result
          changed_when: false
          tags: packages_update

        - name: Retry package installation
          apt:
            name: "{{ common_packages }}"
            state: present
            update_cache: yes
          tags: packages_install

      always:
        - name: Log package installation completion
          copy:
            content: |
              Common role package installation completed at {{ ansible_date_time.iso8601 }}
              Packages installed: {{ common_packages | join(', ') }}
            dest: "/tmp/common_role_completion_{{ ansible_date_time.epoch }}.log"
            mode: '0644'
          run_once: true
          tags: packages_log

      tags: packages
      become: true

    - name: User management block
      block:
        - name: Create application user
          user:
            name: "{{ web_app_user | default('appuser') }}"
            state: present
            groups: "{{ user_groups | default([]) }}"
            shell: /bin/bash
            create_home: yes
          when: create_web_app_user | default(false)
          tags: users_create

        - name: Configure user SSH keys
          authorized_key:
            user: "{{ web_app_user | default('appuser') }}"
            state: present
            key: "{{ item }}"
          loop: "{{ user_ssh_keys | default([]) }}"
          when: user_ssh_keys is defined
          tags: users_ssh

      rescue:
        - name: Handle user creation failure
          debug:
            msg: "User creation failed for {{ web_app_user | default('appuser') }}"
          tags: users_debug

        - name: Get system user list for debugging
          command: "cat /etc/passwd | grep -E '{{ web_app_user | default('appuser') }}'"
          register: user_check
          changed_when: false
          failed_when: false
          tags: users_debug

      always:
        - name: Log user management completion
          lineinfile:
            path: "/tmp/common_role_users.log"
            line: "{{ ansible_date_time.iso8601 }} - User management completed for {{ web_app_user | default('appuser') }}"
            create: yes
            mode: '0644'
          when: create_web_app_user | default(false)
          tags: users_log

      tags: users
      become: true

  tags: common