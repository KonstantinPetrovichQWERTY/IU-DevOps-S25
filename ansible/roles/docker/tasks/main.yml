- name: Docker role tasks
  block:
    - name: Docker installation block
      block:
        - name: Add Docker GPG key
          apt_key:
            url: https://download.docker.com/linux/ubuntu/gpg
            state: present
          register: gpg_result
          tags: docker_gpg

        - name: Add Docker repository
          apt_repository:
            repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
            state: present
            update_cache: yes
          tags: docker_repo

        - name: Install Docker packages
          apt:
            name:
              - docker-ce
              - docker-ce-cli
              - containerd.io
              - docker-buildx-plugin
              - docker-compose-plugin
            state: present
            update_cache: yes
          tags: docker_packages

      rescue:
        - name: Handle GPG key or repository failure
          debug:
            msg: "Docker installation failed, retrying after delay"
          tags: docker_debug

        - name: Wait before retry
          wait_for:
            timeout: 10
          delegate_to: localhost
          tags: docker_debug

        - name: Retry GPG key addition
          apt_key:
            url: https://download.docker.com/linux/ubuntu/gpg
            state: present
          register: retry_gpg
          until: retry_gpg is success
          retries: 3
          delay: 5
          tags: docker_gpg_retry

        - name: Retry Docker installation
          apt:
            name:
              - docker-ce
              - docker-ce-cli
              - containerd.io
              - docker-buildx-plugin
              - docker-compose-plugin
            state: present
            update_cache: yes
          tags: docker_packages_retry

      always:
        - name: Ensure Docker service is configured
          block:
            - name: Ensure Docker service is running and enabled
              service:
                name: docker
                state: started
                enabled: yes
              tags: docker_service

            - name: Verify Docker is running
              command: docker --version
              register: docker_version
              changed_when: false
              tags: docker_verify
              when: not ansible_check_mode

            - name: Display Docker version
              debug:
                msg: "Docker installed: {{ docker_version.stdout }}"
              when: not ansible_check_mode
              tags: docker_verify

      tags: docker_install
      become: true

    - name: Docker configuration block
      block:
        - name: Add user to docker group
          user:
            name: "{{ docker_user }}"
            groups: docker
            append: yes
          register: user_group_result
          tags: docker_usergroup

        - name: Install Python Docker module
          pip:
            name: 
              - docker==6.1.3
              - docker-compose==1.29.2
              - setuptools==59.6.0
              - requests==2.28.2
              - urllib3==1.26.15
            state: present
          tags: 
            - docker_pip
            - compose
            - dependencies

      rescue:
        - name: Handle configuration failure
          debug:
            msg: "Docker configuration failed for user {{ docker_user }}"
          tags: docker_config_debug

        - name: Check if docker group exists
          command: getent group docker
          register: group_check
          changed_when: false
          failed_when: false
          tags: docker_config_debug

      always:
        - name: Log Docker configuration status
          lineinfile:
            path: "/tmp/docker_config_{{ ansible_date_time.date }}.log"
            line: "{{ ansible_date_time.iso8601 }} - Docker configured for user {{ docker_user }}"
            create: yes
            mode: '0644'
          when: user_group_result is changed
          tags: docker_log

      tags: docker_config
      become: true

  tags: docker