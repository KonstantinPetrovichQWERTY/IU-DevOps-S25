---
- name: Docker role tasks
  tags: docker
  block:
    - name: Docker installation block
      tags: docker_install
      become: true

      block:
        - name: Add Docker GPG key
          ansible.builtin.apt_key:
            url: https://download.docker.com/linux/ubuntu/gpg
            state: present
          tags: docker_gpg

        - name: Add Docker repository
          ansible.builtin.apt_repository:
            repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
            state: present
            update_cache: true
          tags: docker_repo

        - name: Install Docker packages
          ansible.builtin.apt:
            name:
              - docker-ce
              - docker-ce-cli
              - containerd.io
              - docker-buildx-plugin
              - docker-compose-plugin
            state: present
            update_cache: true
          tags: docker_packages

      rescue:
        - name: Handle GPG key or repository failure
          ansible.builtin.debug:
            msg: "Docker installation failed, retrying after delay"
          tags: docker_debug

        - name: Wait before retry
          ansible.builtin.wait_for:
            timeout: 10
          delegate_to: localhost
          tags: docker_debug

        - name: Retry GPG key addition
          ansible.builtin.apt_key:
            url: https://download.docker.com/linux/ubuntu/gpg
            state: present
          register: docker_retry_gpg
          until: docker_retry_gpg is success
          retries: 3
          delay: 5
          tags: docker_gpg_retry
          vars:
            ansible_lint_ignore:
              var-naming[no-role-prefix]: true

        - name: Retry Docker installation
          ansible.builtin.apt:
            name:
              - docker-ce
              - docker-ce-cli
              - containerd.io
              - docker-buildx-plugin
              - docker-compose-plugin
            state: present
            update_cache: true
          tags: docker_packages_retry

      always:
        - name: Ensure Docker service is configured
          block:
            - name: Ensure Docker service is running and enabled
              ansible.builtin.service:
                name: docker
                state: started
                enabled: true
              tags: docker_service

            - name: Verify Docker is running
              ansible.builtin.command: docker --version
              register: docker_version
              changed_when: false
              tags: docker_verify
              when: not ansible_check_mode

            - name: Display Docker version
              ansible.builtin.debug:
                msg: "Docker installed: {{ docker_version.stdout }}"
              when: not ansible_check_mode
              tags: docker_verify

    - name: Docker configuration block
      tags: docker_config
      become: true
      block:
        - name: Add user to docker group
          ansible.builtin.user:
            name: "{{ docker_user }}"
            groups: docker
            append: true
          notify: Log docker configuration
          tags: docker_usergroup
          vars:
            ansible_lint_ignore:
              var-naming[no-role-prefix]: true

        - name: Install Python Docker module
          ansible.builtin.pip:
            name:
              - docker==6.1.3
              - docker-compose==1.29.2
              - setuptools==59.6.0
              - requests==2.28.2
              - urllib3==1.26.15
            state: present
          tags:
            - docker_pip
            - compose
            - dependencies

      rescue:
        - name: Handle configuration failure
          ansible.builtin.debug:
            msg: "Docker configuration failed for user {{ docker_user }}"
          tags: docker_config_debug
          vars:
            ansible_lint_ignore:
              var-naming[no-role-prefix]: true

        - name: Check if docker group exists
          ansible.builtin.command: getent group docker
          changed_when: false
          failed_when: false
          tags: docker_config_debug
